{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞</title>
   <link rel="stylesheet" href="{% static 'main/styles/styles.css' %}">
    <style>
        .dropdown {
            display: none;
        }

        .dropdown.show {
            display: block;
        }
    </style>
</head>
<body>
<div class="menu-container">
    <!-- Header with user info and settings -->
    <header>
        <div class="user-info">
            <span class="profile-icon">üë§</span>
            <div class="user-details">
                <span class="username">{{ username }}</span>
                <p class="balance-info">–ë–∞–ª–∞–Ω—Å: <span class="balance">{{ balance }}‚ÇΩ</span></p>
            </div>
        </div>
        <div class="settings">
            <button class="settings-btn" id="settings-button">‚öô –ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
            <div class="dropdown" id="settings-menu">
                <button class="dropdown-item" onclick="window.location.href='/top_up'">–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ</button>
                <button class="dropdown-item" onclick="window.location.href='/withdraw'">–í—ã–≤–æ–¥ —Å—Ä–µ–¥—Å—Ç–≤</button>
                <button class="dropdown-item" onclick="window.location.href='/balance_history'">–ò—Å—Ç–æ—Ä–∏—è –±–∞–ª–∞–Ω—Å–∞ –∏–≥—Ä</button>
                <a href="{% url 'logout' %}">
                    <button type="button" class="dropdown-item">–í—ã–π—Ç–∏</button>
                </a>
            </div>
        </div>
    </header>

    <!-- Flash messages -->
    {% if messages %}
    <div class="flash-messages">
        {% for message in messages %}
            <div class="flash {{ message.tags }}">
                <span class="close-btn" onclick="this.parentElement.style.display='none';">√ó</span>
                {{ message }}
            </div>
        {% endfor %}
    </div>
{% endif %}

    <!-- Main Content -->
    <main>
        <h1>–ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞</h1>
        <div class="menu-options">
            <button onclick="showCreateRoom()" class="button">–°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É</button>
            <button class="button">–°–ø–∏—Å–æ–∫ –∫–æ–º–Ω–∞—Ç (–§–∏–ª—å—Ç—Ä)</button>
            <button class="button disabled">–¢—É—Ä–Ω–∏—Ä—ã (–≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ)</button>
        </div>

        <!-- Form for creating a room -->
        <div id="create-room-form" class="form hidden">
            <h2>–°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã</h2>
            <div id="room-errors" class="flash error hidden"></div> <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –æ—à–∏–±–æ–∫ -->
            <form id="create-room" method="POST" action="/create_room" onsubmit="return validateBlinds(event)">
                <label for="players">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–≥—Ä–æ–∫–æ–≤:</label>
                <input type="number" id="players" name="players" min="2" max="10" required>

                <label for="blinds">–ë–æ–ª—å—à–æ–π –±–ª–∞–π–Ω–¥:</label>
                <input type="number" id="big_blind" name="big_blind" min="1" required>


                <label for="mode">–†–µ–∂–∏–º –∏–≥—Ä—ã:</label>
                <select id="mode" name="mode">
                    <option value="poker" selected>–ü–æ–∫–µ—Ä</option>
                </select>

                <button type="submit" class="submit-btn">–°–æ–∑–¥–∞—Ç—å</button>
            </form>
        </div>

        <script>
         function showCreateRoom() {
        document.getElementById('create-room-form').classList.toggle('hidden');
     }

        function validateBlinds(event) {
            const bigBlindInput = document.getElementById('big_blind').value.trim();
            if (bigBlindInput <= 0) {
                alert('–ë–æ–ª—å—à–æ–π –±–ª–∞–π–Ω–¥ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º —á–∏—Å–ª–æ–º.');
                event.preventDefault();
                return false;
            }
            return true;
        }

            function displayError(message) {
                const errorsContainer = document.getElementById('room-errors');
                errorsContainer.innerHTML = `<span class="close-btn" onclick="this.parentElement.style.display='none';">√ó</span> ${message}`;
                errorsContainer.classList.remove('hidden');
            }
            </script>

        <!-- Room List -->
        <div id="room-list-container">
            <h2>–°–ø–∏—Å–æ–∫ –∫–æ–º–Ω–∞—Ç</h2>
            <div id="room-list">
                <!-- –°–ø–∏—Å–æ–∫ –∫–æ–º–Ω–∞—Ç –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–∞—Ç—å—Å—è —Å—é–¥–∞ -->
            </div>
        </div>

    </main>
</div>

<script>
    // Toggle create room form visibility
    function showCreateRoom() {
        document.getElementById('create-room-form').classList.toggle('hidden');
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–º–Ω–∞—Ç—ã —á–µ—Ä–µ–∑ AJAX
    function submitRoom(event) {
    event.preventDefault();  // Prevent the form from submitting traditionally

    const formData = new FormData(document.getElementById('create-room'));

    fetch('/create_room', {
        method: 'POST',
        body: formData,
    })
    .then(response => response.json())
    .then(data => {
        if (data.room_id) {
            alert(`–ö–æ–º–Ω–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∞! ID: ${data.room_id}`);
            loadRooms(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∫–æ–º–Ω–∞—Ç
            document.getElementById('create-room-form').classList.add('hidden');
        } else if (data.error) {
            console.error(data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
    });
}


    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ –∫–æ–º–Ω–∞—Ç
    function loadRooms() {
        fetch('/get_rooms')
            .then(response => response.text())
            .then(data => {
                document.getElementById('room-list').innerHTML = data;
            });
    }

    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –∫–æ–º–Ω–∞—Ç –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    window.onload = function() {
        loadRooms();
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∫–æ–º–Ω–∞—Ç –∫–∞–∂–¥—ã–µ 1 —Å–µ–∫—É–Ω–¥—É (1000 –º—Å)
        setInterval(loadRooms, 1000); // 1000 –º—Å = 1 —Å–µ–∫—É–Ω–¥–∞
    };

    // Toggle the settings menu
     document.getElementById('create-room').addEventListener('submit', function(event) {
        event.preventDefault();

        const formData = new FormData(this);

        fetch('/create_room', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.room_id) {
                // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Å–æ–∑–¥–∞–Ω–Ω—É—é –∫–æ–º–Ω–∞—Ç—É
                window.location.href = `/rooms/${data.room_id}/`;
            } else if (data.error) {
                alert(data.error);
            }
        })
        .catch(error => console.error('Error:', error));
    });

    // Close the settings menu if clicked outside
    window.onclick = function(event) {
        if (!event.target.matches('#settings-button') && !event.target.matches('.settings-btn')) {
            var dropdowns = document.getElementsByClassName('dropdown');
            for (var i = 0; i < dropdowns.length; i++) {
                var openDropdown = dropdowns[i];
                if (openDropdown.classList.contains('show')) {
                    openDropdown.classList.remove('show');
                }
            }
        }
    };
</script>
</body>
</html>