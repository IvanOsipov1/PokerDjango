{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞</title>
   <link rel="stylesheet" href="{% static main/styles/styles.css %}">
    <style>
        .dropdown {
            display: none;
        }

        .dropdown.show {
            display: block;
        }
    </style>
</head>
<body>
<div class="menu-container">
    <!-- Header with user info and settings -->
    <header>
        <div class="user-info">
            <span class="profile-icon">üë§</span>
            <div class="user-details">
                <span class="username">{{ username }}</span>
                <p class="balance-info">–ë–∞–ª–∞–Ω—Å: <span class="balance">{{ balance }}‚ÇΩ</span></p>
            </div>
        </div>
        <div class="settings">
            <button class="settings-btn" id="settings-button">‚öô –ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
            <div class="dropdown" id="settings-menu">
                <button class="dropdown-item" onclick="window.location.href='/top_up'">–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ</button>
                <button class="dropdown-item" onclick="window.location.href='/withdraw'">–í—ã–≤–æ–¥ —Å—Ä–µ–¥—Å—Ç–≤</button>
                <button class="dropdown-item" onclick="window.location.href='/balance_history'">–ò—Å—Ç–æ—Ä–∏—è –±–∞–ª–∞–Ω—Å–∞ –∏–≥—Ä</button>
                <form action="{{ url_for('logout') }}">
                    <button type="submit" class="dropdown-item">–í—ã–π—Ç–∏</button>
                </form>
            </div>
        </div>
    </header>

    <!-- Flash messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="flash-messages">
                {% for category, message in messages %}
                    <div class="flash {{ category }}">
                        <span class="close-btn" onclick="this.parentElement.style.display='none';">√ó</span>
                        {{ message }}
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    <!-- Main Content -->
    <main>
        <h1>–ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞</h1>
        <div class="menu-options">
            <button onclick="showCreateRoom()" class="button">–°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É</button>
            <button class="button">–°–ø–∏—Å–æ–∫ –∫–æ–º–Ω–∞—Ç (–§–∏–ª—å—Ç—Ä)</button>
            <button class="button disabled">–¢—É—Ä–Ω–∏—Ä—ã (–≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ)</button>
        </div>

        <!-- Form for creating a room -->
        <div id="create-room-form" class="form hidden">
            <h2>–°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã</h2>
            <div id="room-errors" class="flash error hidden"></div> <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –æ—à–∏–±–æ–∫ -->
            <form id="create-room" method="POST" action="/create_room" onsubmit="return validateBlinds(event)">
                <label for="players">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–≥—Ä–æ–∫–æ–≤:</label>
                <input type="number" id="players" name="players" min="2" max="10" required>
                
                <label for="blinds">–ë–ª–∞–π–Ω–¥—ã:</label>
                <input type="text" id="blinds" name="blinds" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, 50/100" required>
        
                <label for="mode">–†–µ–∂–∏–º –∏–≥—Ä—ã:</label>
                <select id="mode" name="mode">
                    <option value="poker" selected>–ü–æ–∫–µ—Ä</option>
                </select>
        
                <button type="submit" class="submit-btn">–°–æ–∑–¥–∞—Ç—å</button>
            </form>
        </div>

        <script>
            function validateBlinds(event) {
                const errorsContainer = document.getElementById('room-errors');
                errorsContainer.classList.add('hidden');
                errorsContainer.innerHTML = ''; // –û—á–∏—Å—Ç–∫–∞ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö –æ—à–∏–±–æ–∫
            
                const blindsInput = document.getElementById('blinds').value.trim();
                const blindsPattern = /^\d+\/\d+$/; // –†–µ–≥—É–ª—è—Ä–Ω–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∞ "—á–∏—Å–ª–æ/—á–∏—Å–ª–æ"
            
                if (!blindsPattern.test(blindsInput)) {
                    displayError('–í–≤–µ–¥–∏—Ç–µ –±–ª–∞–π–Ω–¥—ã –≤ —Ñ–æ—Ä–º–∞—Ç–µ "–ú–∞–ª—ã–π/–ë–æ–ª—å—à–æ–π", –Ω–∞–ø—Ä–∏–º–µ—Ä "50/100".');
                    event.preventDefault(); // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –æ—Ç–ø—Ä–∞–≤–∫—É —Ñ–æ—Ä–º—ã
                    return false;
                }
            
                const [smallBlind, bigBlind] = blindsInput.split('/').map(Number);
                if (smallBlind <= 0 || bigBlind <= 0 || smallBlind >= bigBlind) {
                    displayError('–ú–∞–ª—ã–π –±–ª–∞–π–Ω–¥ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–µ–Ω—å—à–µ –±–æ–ª—å—à–æ–≥–æ –∏ –æ–±–∞ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º–∏.');
                    event.preventDefault();
                    return false;
                }
            
                return true; // –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –æ—Ç–ø—Ä–∞–≤–∫—É —Ñ–æ—Ä–º—ã
            }
            
            function displayError(message) {
                const errorsContainer = document.getElementById('room-errors');
                errorsContainer.innerHTML = `<span class="close-btn" onclick="this.parentElement.style.display='none';">√ó</span> ${message}`;
                errorsContainer.classList.remove('hidden');
            }
            </script>

        <!-- Room List -->
        <div id="room-list-container">
            <h2>–°–ø–∏—Å–æ–∫ –∫–æ–º–Ω–∞—Ç</h2>
            <div id="room-list">
                <!-- –°–ø–∏—Å–æ–∫ –∫–æ–º–Ω–∞—Ç –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–∞—Ç—å—Å—è —Å—é–¥–∞ -->
            </div>
        </div>

    </main>
</div>

<script>
    // Toggle create room form visibility
    function showCreateRoom() {
        document.getElementById('create-room-form').classList.toggle('hidden');
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–º–Ω–∞—Ç—ã —á–µ—Ä–µ–∑ AJAX
    function submitRoom(event) {
        event.preventDefault();  // Prevent the form from submitting traditionally

        const formData = new FormData(document.getElementById('create-room'));
        
        fetch('/create_room', {
            method: 'POST',
            body: formData
        })
        .then(response => response.text())
        .then(data => {
            // –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∫–æ–º–Ω–∞—Ç –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è
            loadRooms();
            // –°–∫—Ä—ã—Ç—å —Ñ–æ—Ä–º—É —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–º–Ω–∞—Ç—ã
            document.getElementById('create-room-form').classList.add('hidden');
        })
        .catch(error => {
            console.error('Error:', error);
        });
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ –∫–æ–º–Ω–∞—Ç
    function loadRooms() {
        fetch('/get_rooms')
            .then(response => response.text())
            .then(data => {
                document.getElementById('room-list').innerHTML = data;
            });
    }

    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –∫–æ–º–Ω–∞—Ç –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    window.onload = function() {
        loadRooms();
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∫–æ–º–Ω–∞—Ç –∫–∞–∂–¥—ã–µ 1 —Å–µ–∫—É–Ω–¥—É (1000 –º—Å)
        setInterval(loadRooms, 1000); // 1000 –º—Å = 1 —Å–µ–∫—É–Ω–¥–∞
    };

    // Toggle the settings menu
    document.getElementById('settings-button').addEventListener('click', function() {
        document.getElementById('settings-menu').classList.toggle('show');
    });

    // Close the settings menu if clicked outside
    window.onclick = function(event) {
        if (!event.target.matches('#settings-button') && !event.target.matches('.settings-btn')) {
            var dropdowns = document.getElementsByClassName('dropdown');
            for (var i = 0; i < dropdowns.length; i++) {
                var openDropdown = dropdowns[i];
                if (openDropdown.classList.contains('show')) {
                    openDropdown.classList.remove('show');
                }
            }
        }
    };
</script>
</body>
</html>