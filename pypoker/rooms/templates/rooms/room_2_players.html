{% extends 'rooms/room_details.html' %}

{% block content %}
    <!-- Места игроков -->
    {% for seat in seats %}
        {% with players|dictsort:"seat_number"|first as player %}
            <div class="player-seat" id="seat-{{ seat }}">
                {% if player %}
                    <div class="player-info">
                        <span>{{ player.user.username }}</span>
                        <span>Stack: {{ player.stack }}</span>
                    </div>
                {% else %}
                    <button class="sit-btn" data-seat="{{ seat }}">SIT</button>
                {% endif %}
            </div>
        {% endwith %}
    {% endfor %}

    <!-- Модальное окно -->
    <div id="buy-in-modal" style="display: none;">
        <form id="buy-in-form">
            <h2>BUY IN</h2>
            <label for="stack">Enter stack amount:</label>
            <input type="number" id="stack" required>
            <button type="submit">Take the seat</button>
        </form>
    </div>

    <script>
        const roomId = "{{ room.unique_id }}";
        const socket = new WebSocket(`ws://${window.location.host}/ws/room/${roomId}/`);
        const modal = document.getElementById('buy-in-modal');
        const form = document.getElementById('buy-in-form');
        let currentSeat = null;

        document.querySelectorAll('.sit-btn').forEach(button => {
            button.addEventListener('click', () => {
                currentSeat = button.getAttribute('data-seat');
                modal.style.display = 'block';
            });
        });

        form.onsubmit = (e) => {
            e.preventDefault();
            const stack = document.getElementById('stack').value;
            socket.send(JSON.stringify({
                action: 'sit',
                seat: currentSeat,
                stack: stack
            }));
            modal.style.display = 'none';
        };

        socket.onmessage = (e) => {
            const data = JSON.parse(e.data);
            if (data.action === 'player_join') {
                const seat = document.getElementById(`seat-${data.seat}`);
                seat.innerHTML = `<div class="player-info">
                    <span>${data.username}</span>
                    <span>Stack: ${data.stack}</span>
                </div>`;
            } else if (data.action === 'load_players') {
                data.players.forEach(player => {
                    const seat = document.getElementById(`seat-${player.seat_number}`);
                    seat.innerHTML = `<div class="player-info">
                        <span>${player.user__username}</span>
                        <span>Stack: ${player.stack}</span>
                    </div>`;
                });
            }
        };
    </script>
{% endblock %}
